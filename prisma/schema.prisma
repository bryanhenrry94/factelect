generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                   String                                             @id @default(uuid())
  name                 String                @map("name")
  subdomain            String                                             @unique
  legalName            String?               @map("legal_name")
  ruc                  String?
  phone                String?               @map("phone")
  contactEmail         String?               @map("contact_email")
  address              String?               @map("address")
  logoUrl              String?               @map("logo_url")
  sriConfig            SRIConfiguration?
  obligatedAccounting  Boolean               @map("obligated_accounting") @default(false)

  createdAt            DateTime              @map("created_at")           @default(now())
  updatedAt            DateTime              @map("updated_at")           @updatedAt

  //                   Relaciones
  users                User[]
  products             Product[]
  persons              Person[]
  invoices             Invoice[]
  transactions         Transaction[]
  transactionDocuments TransactionDocument[]
  accounts             Account[]
  movements            Movement[]

  @@map("tenant")
}

model SRIConfiguration {
  id                  String                                                                                  @id @default(uuid())
  tenantId            String          @map("tenant_id")                                                       @unique
  sriEnvironment      String          @map("sri_environment") // 1 Sandbox | 2 Producci贸n                     @default("1")
  p12CertificatePath  String?         @map("p12_certificate_path") // Ruta o nombre del archivo subido (.p12)
  p12CertificateUrl   String?         @map("p12_certificate_url") // URL p煤blica del archivo .p12
  certificatePassword String?         @map("certificate_password") // Password para el archivo .p12
  establishments      Establishment[]
  emissionPoints      EmissionPoint[]

  createdAt           DateTime        @map("created_at")                                                      @default(now())
  updatedAt           DateTime        @map("updated_at")                                                      @updatedAt

  //                  Relaciones
  tenant              Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("sri_configuration")
}

model Establishment {
  id             String                                                @id @default(cuid())
  sriConfigId    String           @map("sri_configuration_id")
  code           String           @map("code") // 3 d铆gitos, ej: '001'
  address        String           @map("address")
  sriConfig      SRIConfiguration @relation(fields: [sriConfigId], references: [id])
  emissionPoints EmissionPoint[]
  invoices       Invoice[]

  @@map("establishment")
}

model EmissionPoint {
  id                     String                                                @id @default(cuid())
  sriConfigId            String           @map("sri_configuration_id")
  establishmentId        String           @map("establishment_id")
  code                   String           @map("code") // 3 d铆gitos, ej: '002'
  description            String?          @map("description")
  currentInvoiceSequence Int                                                   @default(1)
  isActive               Boolean                                               @default(true)
  sriConfig              SRIConfiguration @relation(fields: [sriConfigId], references: [id])
  establishment          Establishment    @relation(fields: [establishmentId], references: [id])
  invoices               Invoice[]

  @@map("emission_point")
}

model User {
  id                  String               @map("id")         @id @default(cuid())
  email               String               @map("email")      @unique
  password            String               @map("password")
  name                String?              @map("name")
  role                UserRole             @map("role")       @default(USER)

  tenantId            String               @map("tenant_id")
  createdAt           DateTime             @map("created_at") @default(now())
  updatedAt           DateTime             @map("updated_at") @updatedAt
  tenant              Tenant               @relation(fields: [tenantId], references: [id])
  passwordResetTokens PasswordResetToken[]

  @@map("user")
}

model Product {
  id          String        @map("id")          @id @default(cuid())
  code        String        @map("code")        @unique
  description String        @map("description")
  price       Float         @map("price")
  tax         TaxType       @map("tax")         @default(IVA_0)
  tenantId    String        @map("tenant_id")
  createdAt   DateTime      @map("created_at")  @default(now())
  updatedAt   DateTime      @map("updated_at")  @updatedAt
  tenant      Tenant        @relation(fields: [tenantId], references: [id])
  invoiceItem InvoiceItem[]

  @@map("product")
}

model Invoice {
  id                                                       String        @map("id")                                                                         @id @default(cuid())
  personId                                                 String        @map("person_id")
  tenantId                                                 String        @map("tenant_id")

  // Datos de emisi贸n
  establishmentId                                          String        @map("establishment_id") //  Nuevo campo
  emissionPointId                                          String        @map("emission_point_id") //  Nuevo campo
  sequential                                               Int           @map("sequential")
  accessKey                                                String?       @map("access_key") // Clave de acceso generada para el SRI
  authorizationNumber                                      String?       @map("authorization_number") // N煤mero de autorizaci贸n del SRI
  authorizationDate                                        DateTime?     @map("authorization_date") // Fecha de autorizaci贸n del SRI
  status                                                   InvoiceStatus @map("status")                                                                     @default(DRAFT)

  //                                                       Fechas
  issueDate                                                DateTime      @map("issue_date") // Fecha de emisi贸n
  term                                                     Int           @map("term") // Plazo en d铆as para el pago                                         @default(0)
  dueDate                                                  DateTime      @map("due_date") // Fecha de vencimiento

  //                                                       Totales
  total                                                    Float                                                                                            @default(0)
  paidAmount                                               Float         @map("paid_amount")                                                                @default(0)
  balance                                                  Float         @map("balance")                                                                    @default(0)

  // Descripci贸n o observaciones
  description                                              String?       @map("description")

  // Archivos electr贸nicos
  xmlFilePath                                              String?       @map("xml_file_path") // Ruta o URL del XML firmado
  xmlFileUrl                                               String?       @map("xml_file_url") // URL p煤blica del XML firmado
  pdfFilePath                                              String?       @map("pdf_file_path") // Ruta o URL del PDF generado
  pdfFileUrl                                               String?       @map("pdf_file_url") // URL p煤blica del PDF generado
  sriResponse                                              Json?         @map("sri_response") // Guarda respuesta completa del SRI (estado, mensajes, etc.)
  sriError                                                 String?       @map("sri_error") // Guarda mensaje de error en caso de fallo con el SRI
  //                                                       Auditor铆a
  createdAt                                                DateTime      @map("created_at")                                                                 @default(now())
  updatedAt                                                DateTime      @map("updated_at")                                                                 @updatedAt
  canceledAt                                               DateTime?     @map("canceled_at")

  //                                                       Relaciones
  tenant                                                   Tenant        @relation(fields: [tenantId], references: [id])
  establishment                                            Establishment @relation(fields: [establishmentId], references: [id])
  emissionPoint                                            EmissionPoint @relation(fields: [emissionPointId], references: [id])
  person                                                   Person        @relation(fields: [personId], references: [id])
  items          InvoiceItem[] // Productos o servicios
  taxes          InvoiceTax[] //  relaci贸n con impuestos
  paymentMethods InvoicePaymentMethod[] // Formas de pago

  @@index([tenantId])
  @@index([personId])
  @@map("invoice")
}

model InvoiceTax {
  id              String                          @id @default(cuid())
  invoiceId       String  @map("invoice_id")
  code            String  @map("code")
  percentage_code String  @map("percentage_code")
  base            Float   @map("base")            @default(0)
  amount          Float   @map("amount")          @default(0)

  invoice         Invoice @relation(fields: [invoiceId], references: [id])

  @@map("invoice_tax")
}

model InvoiceItem {
  id             String                                           @id @default(cuid())
  invoiceId      String  @map("invoice_id")
  productId      String  @map("product_id")
  quantity       Float   @map("quantity")                         @default(1)
  unitPrice      Float   @map("unit_price")
  tax            TaxType @map("tax")                              @default(IVA_0)
  taxAmount      Float   @map("tax_amount")                       @default(0)
  discountRate   Float   @map("discount_rate") // Ej: 0%, 5%, 10% @default(0)
  discountAmount Float   @map("discount_amount")                  @default(0)
  subtotal       Float   @map("subtotal")
  total          Float   @map("total")

  product        Product @relation(fields: [productId], references: [id])
  invoice        Invoice @relation(fields: [invoiceId], references: [id])

  @@map("invoice_item")
}

model InvoicePaymentMethod {
  id            String                                                                       @id @default(cuid())
  invoiceId     String  @map("invoice_id")
  paymentMethod String  @map("payment_method") // Ej: "EFECTIVO", "TRANSFERENCIA", "TARJETA"
  term          Int?    @map("term")
  timeUnit      String? @map("time_unit") // Ej: "DIAS"
  amount        Float   @map("amount")

  invoice       Invoice @relation(fields: [invoiceId], references: [id])

  @@map("invoice_payment")
}

model PasswordResetToken {
  id        String   @map("id")         @id @default(cuid())
  token     String   @map("token")      @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @map("created_at") @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_token")
}

model Transaction {
  id          String                                   @id @default(cuid())
  type        TransactionType
  method      PaymentMethod
  issueDate   DateTime              @map("issue_date")
  reference   String?
  description String?

  tenantId    String                @map("tenant_id")
  tenant      Tenant                @relation(fields: [tenantId], references: [id])

  //          Relations
  personId    String                @map("person_id")
  person      Person                @relation(fields: [personId], references: [id])

  accountId   String                @map("account_id")
  account     Account               @relation(fields: [accountId], references: [id])

  // Documents associated (incomes or expenses)
  documents   TransactionDocument[]

  createdAt   DateTime                                 @default(now())
  updatedAt   DateTime                                 @updatedAt
  movement    Movement[]

  @@map("transaction")
}

model TransactionDocument {
  id            String                             @id @default(cuid())
  transactionId String      @map("transaction_id")
  documentId    String      @map("document_id")
  amount        Float
  tenantId      String      @map("tenant_id")
  createdAt     DateTime    @map("created_at")     @default(now())
  updatedAt     DateTime    @map("updated_at")     @updatedAt

  tenant        Tenant      @relation(fields: [tenantId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id])

  @@map("transaction_document")
}

model Account {
  id                                                                     String                           @id @default(cuid())
  tenantId                                                               String        @map("tenant_id")
  name                                                                   String
  type                                                                   AccountType
  balance                                                                Float                            @default(0)
  currency                                                               String                           @default("USD")

  // datos opcionales seg煤n el tipo
  bank   String? // Banco Pichincha, etc.
  number String? // N煤mero de cuenta
  last4  String? // Para tarjetas

  transactions                                                           Transaction[]
  movements    Movement[] // BankMovement o CashMovement si los unificas

  createdAt                                                              DateTime      @map("created_at") @default(now())
  tenant                                                                 Tenant        @relation(fields: [tenantId], references: [id])

  @@map("account")
}

model Movement {
  id                                                              String                              @id @default(cuid())
  tenantId                                                        String       @map("tenant_id")

  accountId                                                       String       @map("account_id")
  account                                                         Account      @relation(fields: [accountId], references: [id])

  transactionId                                                   String?      @map("transaction_id")
  transaction                                                     Transaction? @relation(fields: [transactionId], references: [id])

  type   MovementType // IN | OUT
  amount                                                          Float                               @default(0)

  date                                                            DateTime                            @default(now()) // fecha real del movimiento
  description                                                     String?

  // Soporte para conciliaci贸n futura
  reference    String? // # de transferencia, #dep贸sito, #voucher
  reconciled                                                      Boolean                             @default(false)
  reconciledAt                                                    DateTime?    @map("reconciled_at")

  createdAt                                                       DateTime     @map("created_at")     @default(now())
  updatedAt                                                       DateTime     @map("updated_at")     @updatedAt
  tenant                                                          Tenant       @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([accountId])
  @@index([transactionId])
  @@map("movement")
}

model Person {
  id                 String                                         @id @default(cuid())
  identificationType IdentificationType @map("identification_type")
  identification     String             @map("identification")      @unique
  firstName          String             @map("first_name")
  lastName           String             @map("last_name")
  email              String             @map("email")               @unique
  phone              String?            @map("phone")
  address            String?            @map("address")
  roles              PersonRole[]                                   @default([])

  tenantId           String             @map("tenant_id")
  createdAt          DateTime           @map("created_at")          @default(now())
  updatedAt          DateTime           @map("updated_at")          @updatedAt
  tenant             Tenant             @relation(fields: [tenantId], references: [id])

  transactions       Transaction[]
  invoice            Invoice[]

  @@map("person")
}

enum UserRole {
  ADMIN
  USER
}

enum IdentificationType {
  RUC
  CEDULA
  PASAPORTE
  VENTA_A_CONSUMIDOR_FINAL
  IDENTIFICACION_DE_EXTERIOR
  PLACA
}

enum TaxType {
  IVA_0
  IVA_5
  IVA_12
  IVA_14
  IVA_15
  NO_IVA
  EXENTO_IVA
}

enum TransactionType {
  INCOME // Cobro
  EXPENSE // Pago
}

enum PaymentMethod {
  CASH // Caja
  TRANSFER // Transferencia
  PETTY_CASH // Caja chica (solo para pagos)
  CREDIT_CARD // Tarjeta cr茅dito (solo para pagos)
}

enum InvoiceStatus {
  DRAFT // Borrador, editable
  SIGNED // Firmada digitalmente
  SENT // Enviada al SRI
  PENDING_AUTHORIZATION // En espera de autorizaci贸n del SRI
  AUTHORIZED // Autorizada por el SRI
  REJECTED // Rechazada por el SRI
  CANCELED // Anulada o cancelada por el emisor
}

enum PersonRole {
  CLIENT
  SUPPLIER
  SELLER
}

enum AccountType {
  BANK
  CASH
  CREDIT_CARD
  // WALLET
  // PAYMENT_GATEWAY
}

enum MovementType {
  IN // Aumenta saldo
  OUT // Disminuye saldo
}
