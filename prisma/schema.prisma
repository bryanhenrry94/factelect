generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id           String                                  @id @default(uuid())
  name         String            @map("name")
  subdomain    String                                  @unique
  legalName    String?           @map("legal_name")
  ruc          String?
  phone        String?           @map("phone")
  contactEmail String?           @map("contact_email")
  address      String?           @map("address")
  logoUrl      String?           @map("logo_url")
  sriConfig    SRIConfiguration?

  createdAt    DateTime          @map("created_at")    @default(now())
  updatedAt    DateTime          @map("updated_at")    @updatedAt
  users        User[]
  products     Product[]
  clients      Customer[]
  invoices     Invoice[]

  @@map("tenant")
}

model SRIConfiguration {
  id                  String                                                                                  @id @default(uuid())
  tenantId            String          @map("tenant_id")                                                       @unique
  sriEnvironment      String          @map("sri_environment") // 1 Sandbox | 2 Producci칩n                     @default("1")
  p12CertificatePath  String?         @map("p12_certificate_path") // Ruta o nombre del archivo subido (.p12)
  p12CertificateUrl   String?         @map("p12_certificate_url") // URL p칰blica del archivo .p12
  certificatePassword String?         @map("certificate_password") // Password para el archivo .p12
  establishments      Establishment[]
  emissionPoints      EmissionPoint[]

  createdAt           DateTime        @map("created_at")                                                      @default(now())
  updatedAt           DateTime        @map("updated_at")                                                      @updatedAt

  //                  Relaciones
  tenant              Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("sri_configuration")
}

model Establishment {
  id             String                                                @id @default(cuid())
  sriConfigId    String           @map("sri_configuration_id")
  code           String           @map("code") // 3 d칤gitos, ej: '001'
  address        String           @map("address")
  sriConfig      SRIConfiguration @relation(fields: [sriConfigId], references: [id])
  emissionPoints EmissionPoint[]

  @@map("establishment")
}

model EmissionPoint {
  id                     String                                                @id @default(cuid())
  sriConfigId            String           @map("sri_configuration_id")
  establishmentId        String           @map("establishment_id")
  code                   String           @map("code") // 3 d칤gitos, ej: '002'
  description            String?          @map("description")
  currentInvoiceSequence Int                                                   @default(1)
  isActive               Boolean                                               @default(true)
  sriConfig              SRIConfiguration @relation(fields: [sriConfigId], references: [id])
  establishment          Establishment    @relation(fields: [establishmentId], references: [id])
  invoices               Invoice[]

  @@map("emission_point")
}

model User {
  id                  String               @map("id")         @id @default(cuid())
  email               String               @map("email")      @unique
  password            String               @map("password")
  name                String?              @map("name")

  tenantId            String               @map("tenant_id")
  createdAt           DateTime             @map("created_at") @default(now())
  updatedAt           DateTime             @map("updated_at") @updatedAt
  tenant              Tenant               @relation(fields: [tenantId], references: [id])
  passwordResetTokens PasswordResetToken[]

  @@map("user")
}

enum UserRole {
  ADMIN
  USER
}

model Customer {
  id                 String             @map("id")                  @id @default(cuid())
  identificationType IdentificationType @map("identification_type")
  identification     String             @map("identification")      @unique
  name               String             @map("name")
  email              String             @map("email")               @unique
  phone              String?            @map("phone")
  address            String?            @map("address")
  notes              String?            @map("notes")
  tenantId           String             @map("tenant_id")
  createdAt          DateTime           @map("created_at")          @default(now())
  updatedAt          DateTime           @map("updated_at")          @updatedAt
  tenant             Tenant             @relation(fields: [tenantId], references: [id])
  Invoice            Invoice[]

  @@map("customer")
}

model Product {
  id          String        @map("id")          @id @default(cuid())
  code        String        @map("code")        @unique
  description String        @map("description")
  price       Float         @map("price")
  tax         taxType       @map("tax")         @default(IVA_0)
  tenantId    String        @map("tenant_id")
  createdAt   DateTime      @map("created_at")  @default(now())
  updatedAt   DateTime      @map("updated_at")  @updatedAt
  tenant      Tenant        @relation(fields: [tenantId], references: [id])
  InvoiceItem InvoiceItem[]

  @@map("product")
}

model Invoice {
  id                                                       String        @map("id")                                                                         @id @default(cuid())
  customerId                                               String        @map("customer_id")
  tenantId                                                 String        @map("tenant_id")

  // Datos de emisi칩n
  emissionPointId                                          String        @map("emission_point_id") // 游댳 Nuevo campo
  sequential                                               Int           @map("sequential")
  accessKey                                                String?       @map("access_key") // Clave de acceso generada para el SRI                         @unique
  authorization                                            String?       @map("authorization") // N칰mero de autorizaci칩n del SRI
  status                                                   String        @map("status") // PENDING | AUTHORIZED | REJECTED | CANCELED                       @default("PENDING")

  //                                                       Fechas
  issueDate                                                DateTime      @map("issue_date") // Fecha de emisi칩n
  term                                                     Int           @map("term") // Plazo en d칤as para el pago                                         @default(0)
  dueDate                                                  DateTime      @map("due_date") // Fecha de vencimiento

  //                                                       Totales
  total                                                    Float                                                                                            @default(0)

  // Descripci칩n o observaciones
  description                                              String?       @map("description")

  // Archivos electr칩nicos
  xmlFilePath                                              String?       @map("xml_file_path") // Ruta o URL del XML firmado
  xmlFileUrl                                               String?       @map("xml_file_url") // URL p칰blica del XML firmado
  pdfFilePath                                              String?       @map("pdf_file_path") // Ruta o URL del PDF generado
  pdfFileUrl                                               String?       @map("pdf_file_url") // URL p칰blica del PDF generado
  sriResponse                                              Json?         @map("sri_response") // Guarda respuesta completa del SRI (estado, mensajes, etc.)

  //                                                       Auditor칤a
  createdAt                                                DateTime      @map("created_at")                                                                 @default(now())
  updatedAt                                                DateTime      @map("updated_at")                                                                 @updatedAt
  canceledAt                                               DateTime?     @map("canceled_at")

  //                                                       Relaciones
  tenant                                                   Tenant        @relation(fields: [tenantId], references: [id])
  emissionPoint                                            EmissionPoint @relation(fields: [emissionPointId], references: [id])
  customer                                                 Customer      @relation(fields: [customerId], references: [id])
  items          InvoiceItem[] // Productos o servicios
  taxes          InvoiceTax[] // 游댳 relaci칩n con impuestos
  paymentMethods InvoicePaymentMethod[] // Formas de pago

  @@index([tenantId])
  @@index([customerId])
  @@map("invoice")
}

model InvoiceTax {
  id              String                          @id @default(cuid())
  invoiceId       String  @map("invoice_id")
  code            String  @map("code")
  percentage_code String  @map("percentage_code")
  base            Float   @map("base")            @default(0)
  amount          Float   @map("amount")          @default(0)

  invoice         Invoice @relation(fields: [invoiceId], references: [id])

  @@map("invoice_tax")
}

model InvoiceItem {
  id             String                                           @id @default(cuid())
  invoiceId      String  @map("invoice_id")
  productId      String  @map("product_id")
  quantity       Float   @map("quantity")                         @default(1)
  unitPrice      Float   @map("unit_price")
  tax            taxType @map("tax")                              @default(IVA_0)
  taxAmount      Float   @map("tax_amount")                       @default(0)
  discountRate   Float   @map("discount_rate") // Ej: 0%, 5%, 10% @default(0)
  discountAmount Float   @map("discount_amount")                  @default(0)
  subtotal       Float   @map("subtotal")

  product        Product @relation(fields: [productId], references: [id])
  invoice        Invoice @relation(fields: [invoiceId], references: [id])

  @@map("invoice_item")
}

model InvoicePaymentMethod {
  id            String                                                                       @id @default(cuid())
  invoiceId     String  @map("invoice_id")
  paymentMethod String  @map("payment_method") // Ej: "EFECTIVO", "TRANSFERENCIA", "TARJETA"
  term          Int?    @map("term")
  timeUnit      String? @map("time_unit") // Ej: "DIAS"
  amount        Float   @map("amount")

  invoice       Invoice @relation(fields: [invoiceId], references: [id])

  @@map("invoice_payment")
}

model PasswordResetToken {
  id        String   @map("id")         @id @default(cuid())
  token     String   @map("token")      @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @map("created_at") @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_token")
}

enum IdentificationType {
  RUC
  CEDULA
  PASAPORTE
  VENTA_A_CONSUMIDOR_FINAL
  IDENTIFICACION_DE_EXTERIOR
  PLACA
}

enum taxType {
  IVA_0
  IVA_5
  IVA_12
  IVA_14
  IVA_15
  NO_IVA
  EXENTO_IVA
}
