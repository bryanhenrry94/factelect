generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                       String                                                       @id @default(uuid())
  //                       Identidad
  legalName                String                    @map("legal_name")
  tradeName                String?                   @map("trade_name")
  ruc                      String                    @map("ruc")
  subdomain                String                                                       @unique

  // Datos fiscales
  contributorType          ContributorType           @map("contributor_type")
  taxRegime                TaxRegime                 @map("tax_regime")
  obligatedAccounting      Boolean                   @map("obligated_accounting")       @default(false)
  isWithholdingAgent       Boolean                   @map("is_withholding_agent")       @default(false)
  isSpecialContributor     Boolean                   @map("is_special_contributor")     @default(false)
  specialContributorNumber String?                   @map("special_contributor_number")
  economicActivity         String?                   @map("economic_activity")

  // Contacto fiscal
  address                  String?                   @map("address")
  phone                    String?                   @map("phone")
  email                    String?                   @map("email")

  //                       Branding
  logoUrl                  String?                   @map("logo_url")

  // SRI Configuration
  sriConfiguration         SRIConfiguration?

  createdAt                DateTime                  @map("created_at")                 @default(now())
  updatedAt                DateTime                  @map("updated_at")                 @updatedAt

  //                       Relaciones
  documents                Document[]
  products                 Product[]
  persons                  Person[]
  transactions             Transaction[]
  transactionDocuments     TransactionDocument[]
  bankAccounts             BankAccount[]
  bankMovements            BankMovement[]
  bankTransfers            BankTransfer[]
  cashBoxes                CashBox[]
  cashSessions             CashSession[]
  cashMovements            CashMovement[]
  cashCounts               CashCount[]
  cashReconciliations      CashReconciliation[]
  establishments           Establishment[]
  emissionPoints           EmissionPoint[]
  category                 Category[]
  warehouse                Warehouse[]
  stock                    Stock[]
  inventoryMovement        InventoryMovement[]
  warehouseTransfer        WarehouseTransfer[]
  units                    Unit[]
  inventoryAdjustment      InventoryAdjustment[]
  warehouseTransferItems   WarehouseTransferItem[]
  inventoryMovementItems   InventoryMovementItem[]
  inventoryAdjustmentItem  InventoryAdjustmentItem[]
  bankMovementDetail       BankMovementDetail[]
  memberships              Membership[]
  tenantInvitations        TenantInvitation[]

  @@map("tenant")
}

model SRIConfiguration {
  id                  String                                                                             @id @default(uuid())
  tenantId            String         @map("tenant_id")                                                   @unique
  environment         SRIEnvironment @map("sri_environment") // 1 Sandbox | 2 Producci√≥n                 @default("1")
  certificatePath     String?        @map("certificate_path") // Ruta o nombre del archivo subido (.p12)
  certificateUrl      String?        @map("certificate_url") // URL p√∫blica del archivo .p12
  certificatePassword String?        @map("certificate_password") // Password para el archivo .p12

  createdAt           DateTime       @map("created_at")                                                  @default(now())
  updatedAt           DateTime       @map("updated_at")                                                  @updatedAt

  //                  Relaciones
  tenant              Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("sri_configuration")
}

model TenantInvitation {
  id        String                      @id @default(uuid())
  tenantId  String   @map("tenant_id")
  email     String   @map("email")
  token     String   @map("token")      @unique
  createdAt DateTime @map("created_at") @default(now())

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_invitation")
}

model Establishment {
  id                 String                                                    @id @default(cuid())
  tenantId           String               @map("tenant_id")
  tenant             Tenant               @relation(fields: [tenantId], references: [id])
  code               String               @map("code") // 3 d√≠gitos, ej: '001'
  address            String               @map("address")
  isActive           Boolean                                                   @default(true)

  documentFiscalInfo DocumentFiscalInfo[]
  emissionPoints     EmissionPoint[]

  @@map("establishment")
}

model EmissionPoint {
  id                 String                                            @id @default(cuid())
  tenantId           String                  @map("tenant_id")
  establishmentId    String                  @map("establishment_id")
  code               String                  @map("code") // ej: '002'
  description        String?
  isActive           Boolean                                           @default(true)

  sequences          EmissionPointSequence[]

  tenant             Tenant                  @relation(fields: [tenantId], references: [id])
  establishment      Establishment           @relation(fields: [establishmentId], references: [id])
  documentFiscalInfo DocumentFiscalInfo[]

  @@unique([tenantId, establishmentId, code])
  @@map("emission_point")
}

model EmissionPointSequence {
  id              String                                  @id @default(cuid())
  emissionPointId String        @map("emission_point_id")
  emissionPoint   EmissionPoint @relation(fields: [emissionPointId], references: [id])
  documentType    DocumentType
  currentSequence Int                                     @default(1)

  @@unique([emissionPointId, documentType])
  @@map("emission_point_sequence")
}


model User {
  id                  String               @map("id")                   @id @default(cuid())
  name                String?              @map("name")
  email               String               @map("email")                @unique
  password            String               @map("password")
  onboardingCompleted Boolean              @map("onboarding_completed") @default(false)
  active              Boolean              @map("active")               @default(true)
  isAdmin             Boolean              @map("is_admin")             @default(false)

  createdAt           DateTime             @map("created_at")           @default(now())
  updatedAt           DateTime             @map("updated_at")           @updatedAt

  passwordResetTokens PasswordResetToken[]
  cashSessions        CashSession[]
  memberships         Membership[]

  @@map("user")
}

model Membership {
  id       String   @map("id")        @id @default(cuid())
  userId   String   @map("user_id")
  tenantId String   @map("tenant_id")
  role     UserRole @map("role")      @default(USER)

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@map("membership")
}

model Product {
  id                       String                    @map("id")                   @id @default(cuid())

  tenantId                 String                    @map("tenant_id")
  tenant                   Tenant                    @relation(fields: [tenantId], references: [id])

  code                     String                    @map("code")
  description              String                    @map("description")
  price                    Float                     @map("price")
  tax                      TaxType                   @map("tax")                  @default(IVA_0)
  type                     ProductType                                            @default(PRODUCT) // PRODUCT | SERVICE
  barcode                  String?                                                @unique

  unitId                   String
  unit                     Unit                      @relation(fields: [unitId], references: [id])

  categoryId               String                    @map("category_id")
  category                 Category                  @relation(fields: [categoryId], references: [id])

  createdAt                DateTime                  @map("created_at")           @default(now())
  updatedAt                DateTime                  @map("updated_at")           @updatedAt

  salesAccountId           String?                   @map("sales_account_id")
  salesAccount             ChartOfAccount?           @relation("ProductSalesAccount", fields: [salesAccountId], references: [id])

  inventoryAccountId       String?                   @map("inventory_account_id")
  inventoryAccount         ChartOfAccount?           @relation("ProductInventoryAccount", fields: [inventoryAccountId], references: [id])

  costAccountId            String?                   @map("cost_account_id")
  costAccount              ChartOfAccount?           @relation("ProductCostAccount", fields: [costAccountId], references: [id])

  isActive                 Boolean                                                @default(true)

  documentItems            DocumentItem[]
  stocks                   Stock[]
  warehouseTransferItem    WarehouseTransferItem[]
  inventoryAdjustmentItems InventoryAdjustmentItem[]
  inventoryMovementItems   InventoryMovementItem[]

  @@unique([tenantId,      code])
  @@map("product")
}

model Unit {
  id                       String                                      @id @default(cuid())
  tenantId                 String                    @map("tenant_id")
  name                     String
  symbol                   String

  tenant                   Tenant                    @relation(fields: [tenantId], references: [id])
  products                 Product[]
  warehouseTransferItems   WarehouseTransferItem[]
  inventoryAdjustmentItems InventoryAdjustmentItem[]
  inventoryMovementItems   InventoryMovementItem[]

  @@map("unit")
}

model Category {
  id       String                      @id @default(cuid())
  tenantId String    @map("tenant_id")
  name     String

  products Product[]
  tenant   Tenant    @relation(fields: [tenantId], references: [id])

  @@map("category")
}

model Stock {
  id          String                         @id @default(cuid())
  tenantId    String    @map("tenant_id")
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  productId   String    @map("product_id")
  product     Product   @relation(fields: [productId], references: [id])
  warehouseId String    @map("warehouse_id")
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  quantity    Decimal                        @default(0)
  minQuantity Decimal                        @default(0)
  avgCost     Decimal?  @map("avg_cost")
  totalCost   Decimal?  @map("total_cost")

  @@unique([productId, warehouseId])
  @@map("stock")
}

model InventoryMovement {
  id           String                                        @id @default(cuid())
  tenantId     String                  @map("tenant_id")
  tenant       Tenant                  @relation(fields: [tenantId], references: [id])
  type         InventoryMoveType       @map("type")
  warehouseId  String                  @map("warehouse_id")
  warehouse    Warehouse               @relation(fields: [warehouseId], references: [id])
  date         DateTime                                      @default(now())
  description  String
  documentId   String?                 @map("document_id")
  document     Document?               @relation(fields: [documentId], references: [id])

  transferId   String?                 @map("transfer_id")
  transfer     WarehouseTransfer?      @relation(fields: [transferId], references: [id])

  adjustmentId String?                 @map("adjustment_id")
  adjustment   InventoryAdjustment?    @relation(fields: [adjustmentId], references: [id])

  items        InventoryMovementItem[]

  @@index([warehouseId])
  @@index([documentId])
  @@map("inventory_movement")
}

model InventoryMovementItem {
  id              String                                      @id @default(cuid())
  tenantId        String            @map("tenant_id")
  tenant          Tenant            @relation(fields: [tenantId], references: [id])
  inventoryMoveId String            @map("inventory_move_id")
  inventoryMove   InventoryMovement @relation(fields: [inventoryMoveId], references: [id])
  productId       String            @map("product_id")
  product         Product           @relation(fields: [productId], references: [id])
  quantity        Float
  unitId          String            @map("unit_id")
  unit            Unit              @relation(fields: [unitId], references: [id])
  cost            Float
  totalCost       Float

  @@map("inventory_movement_item")
}

model InventoryAdjustment {
  id                String                                       @id @default(cuid())
  tenantId          String                    @map("tenant_id")
  tenant            Tenant                    @relation(fields: [tenantId], references: [id])
  date              DateTime                                     @default(now())
  description       String
  createdBy         String                    @map("created_by")

  items             InventoryAdjustmentItem[]
  inventoryMovement InventoryMovement[]

  @@map("inventory_adjustment")
}

model InventoryAdjustmentItem {
  id           String                                    @id @default(cuid())
  tenantId     String              @map("tenant_id")
  tenant       Tenant              @relation(fields: [tenantId], references: [id])

  adjustmentId String              @map("adjustment_id")
  adjustment   InventoryAdjustment @relation(fields: [adjustmentId], references: [id])

  productId    String              @map("product_id")
  product      Product             @relation(fields: [productId], references: [id])

  unitId       String              @map("unit_id")
  unit         Unit                @relation(fields: [unitId], references: [id])

  warehouseId  String              @map("warehouse_id")
  warehouse    Warehouse           @relation(fields: [warehouseId], references: [id])

  quantity     Float
  cost         Float?

  @@map("inventory_adjustment_item")
}

model Warehouse {
  id                       String                                                 @id @default(cuid())
  tenantId                 String                    @map("tenant_id")
  tenant                   Tenant                    @relation(fields: [tenantId], references: [id])
  name                     String

  accountInventoryId       String?                   @map("account_inventory_id")
  accountInventory         ChartOfAccount?           @relation("WarehouseInventoryAccount", fields: [accountInventoryId], references: [id])

  costCenterId             String?                   @map("cost_center_id")
  costCenter               CostCenter?               @relation(fields: [costCenterId], references: [id])

  isActive                 Boolean                                                @default(true)

  stocks                   Stock[]
  movements                InventoryMovement[]
  documentItems            DocumentItem[]
  inventoryAdjustmentItems InventoryAdjustmentItem[]
  transfersFrom            WarehouseTransfer[]       @relation("TransferFromWarehouse")
  transfersTo              WarehouseTransfer[]       @relation("TransferToWarehouse")

  @@map("warehouse")
}

model WarehouseTransfer {
  id                String                                            @id @default(cuid())
  tenantId          String                  @map("tenant_id")
  tenant            Tenant                  @relation(fields: [tenantId], references: [id])
  date              DateTime                                          @default(now())
  description       String
  fromWarehouseId   String                  @map("from_warehouse_id")
  fromWarehouse     Warehouse               @relation("TransferFromWarehouse", fields: [fromWarehouseId], references: [id])
  toWarehouseId     String                  @map("to_warehouse_id")
  toWarehouse       Warehouse               @relation("TransferToWarehouse", fields: [toWarehouseId], references: [id])

  items             WarehouseTransferItem[]
  inventoryMovement InventoryMovement[]

  @@map("warehouse_transfer")
}

model WarehouseTransferItem {
  id         String                                @id @default(cuid())
  tenantId   String            @map("tenant_id")
  tenant     Tenant            @relation(fields: [tenantId], references: [id])

  transferId String            @map("transfer_id")
  transfer   WarehouseTransfer @relation(fields: [transferId], references: [id])

  productId  String            @map("product_id")
  product    Product           @relation(fields: [productId], references: [id])

  unitId     String            @map("unit_id")
  unit       Unit              @relation(fields: [unitId], references: [id])

  quantity   Float

  @@map("warehouse_transfer_item")
}

model Document {
  id                  String                                                                            @id @default(cuid())
  tenantId            String                @map("tenant_id")
  entityType          EntityType                                                                        @default(CUSTOMER) // Cliente | Proveedor
  documentType        DocumentType
  number              String?
  issueDate           DateTime              @map("issue_date")                                          @default(now())
  dueDate             DateTime?             @map("due_date")                                            @default(now())
  status              DocumentStatus                                                                    @default(DRAFT) // draft | confirmed | canceled
  personId            String                @map("person_id") // Cliente (opcional si es venta abierta)

  //                  Totales
  subtotal            Float                                                                             @default(0)
  taxTotal            Float                 @map("tax_total")                                           @default(0)
  discount            Float                                                                             @default(0)
  total               Float                                                                             @default(0)
  paidAmount          Float                 @map("paid_amount")                                         @default(0)
  balance             Float                                                                             @default(0)

  description         String?               @map("description")

  //                  Auditor√≠a
  createdAt           DateTime              @map("created_at")                                          @default(now())
  updatedAt           DateTime              @map("updated_at")                                          @updatedAt

  //                  Relaciones
  tenant              Tenant                @relation(fields: [tenantId], references: [id])
  person              Person                @relation(fields: [personId], references: [id])

  items               DocumentItem[]
  taxes               DocumentTax[]

  documentFiscalInfo  DocumentFiscalInfo?
  documentPayments    DocumentPayment[]
  inventoryMovement   InventoryMovement[]
  transactionDocument TransactionDocument[]

  @@unique([tenantId, number])
  @@index([tenantId])
  @@index([personId])
  @@map("document")
}

model DocumentItem {
  id             String                            @id @default(cuid())
  documentId     String    @map("document_id")
  document       Document  @relation(fields: [documentId], references: [id])

  productId      String    @map("product_id")
  product        Product   @relation(fields: [productId], references: [id])

  warehouseId    String    @map("warehouse_id")
  warehouse      Warehouse @relation(fields: [warehouseId], references: [id])

  quantity       Float                             @default(1)
  unitPrice      Float
  tax            TaxType                           @default(IVA_0)
  taxAmount      Float                             @default(0)
  discountRate   Float     @map("discount_rate")   @default(0)
  discountAmount Float     @map("discount_amount") @default(0)
  subtotal       Float
  total          Float

  @@map("document_item")
}

model DocumentTax {
  id              String                           @id @default(cuid())
  documentId      String   @map("document_id")
  code            String   @map("code")
  percentage_code String   @map("percentage_code")
  base            Float                            @default(0)
  amount          Float                            @default(0)

  document        Document @relation(fields: [documentId], references: [id])

  @@map("document_tax")
}

model DocumentFiscalInfo {
  id                String                                                                           @id @default(cuid())

  documentId        String         @map("document_id")                                               @unique
  document          Document       @relation(fields: [documentId], references: [id])

  establishmentId   String         @map("establishment_id") // 001
  establishment     Establishment  @relation(fields: [establishmentId], references: [id])
  emissionPointId   String         @map("emission_point_id") // 002
  emissionPoint     EmissionPoint  @relation(fields: [emissionPointId], references: [id])
  sequence          Int

  accessKey         String?        @map("access_key") // Clave de acceso
  authorization     String?        @map("authorization") // N√∫mero de autorizaci√≥n
  authorizationDate DateTime?      @map("authorization_date") // Fecha de autorizaci√≥n

  sriStatus         SRIStatus      @map("sri_status")                                                @default(DRAFT) // Estado del documento en el SRI
  environment       SRIEnvironment                                                                   @default(TEST) // 1 pruebas, 2 producci√≥n

  generatedXmlUrl   String?        @map("generated_xml_url") // URL al XML firmado
  generatedXmlPath  String?        @map("generated_xml_path") // Ruta al XML firmado en el servidor

  authorizedXmlUrl  String?        @map("authorized_xml_url") // URL XML autorizado
  authorizedXmlPath String?        @map("authorized_xml_path") // Ruta XML autorizado en el servidor

  rawResponse       String?        @map("raw_response") // Respuesta cruda del SRI

  pdfUrl            String?        @map("pdf_url") // URL del PDF RIDE

  @@map("document_fiscal_info")
}

model DocumentPayment {
  id            String   @map("id")                                        @id @default(uuid())

  documentId    String   @map("document_id")
  document      Document @relation(fields: [documentId], references: [id])

  paymentMethod String   @map("payment_method") // formaPago (c√≥digos SRI)
  amount        Decimal  @map("amount") // total
  term          Int?     @map("term") // plazo
  termUnit      String?  @map("term_unit") // unidadTiempo: "dias"

  createdAt     DateTime @map("created_at")                                @default(now())

  @@map("document_payment")
}

model Retention {
  id         String                            @id @default(cuid())
  tenantId   String        @map("tenant_id")
  documentId String        @map("document_id")
  type       RetentionType
  percentage Float
  base       Float
  amount     Float

  @@map("retention")
}

model PasswordResetToken {
  id        String   @map("id")         @id @default(cuid())
  token     String   @map("token")      @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @map("created_at") @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_token")
}

model Transaction {
  id                                                        String                                                                            @id @default(cuid())
  tenantId                                                  String                @map("tenant_id")

  personId                                                  String                @map("person_id")

  type   TransactionType // INCOME | EXPENSE
  method PaymentMethod // CASH, TRANSFER, CARD, CHECK, etc.

  amount                                                    Float
  issueDate                                                 DateTime              @map("issue_date")
  reference                                                 String?
  description                                               String?

  // Relaci√≥n con Persona (cliente o proveedor)
  person                                                    Person                @relation(fields: [personId], references: [id])

  // Documentos pagados / cobrados
  documents                                                 TransactionDocument[]

  // Conciliaci√≥n futura
  reconciled                                                Boolean                                                                           @default(false)
  reconciledAt                                              DateTime?             @map("reconciled_at")

  bankAccountId                                             String?               @map("bank_account_id") // cuenta bancaria usada (opcional)
  bankAccount                                               BankAccount?          @relation(fields: [bankAccountId], references: [id])

  cashBoxId                                                 String?               @map("cash_box_id") // caja usada (opcional)
  cashBox                                                   CashBox?              @relation(fields: [cashBoxId], references: [id])

  createdAt                                                 DateTime                                                                          @default(now())
  updatedAt                                                 DateTime                                                                          @updatedAt

  tenant                                                    Tenant                @relation(fields: [tenantId], references: [id])

  cashMovements                                             CashMovement[]
  bankMovements                                             BankMovement[]

  @@map("transaction")
}

model TransactionDocument {
  id                                            String                             @id @default(cuid())
  tenantId                                      String      @map("tenant_id")
  transactionId                                 String      @map("transaction_id")
  documentId                                    String      @map("document_id")

  amount Float // pago aplicado a ese documento

  document                                      Document    @relation(fields: [documentId], references: [id])
  transaction                                   Transaction @relation(fields: [transactionId], references: [id])

  createdAt                                     DateTime    @map("created_at")     @default(now())
  updatedAt                                     DateTime    @map("updated_at")     @updatedAt

  tenant                                        Tenant      @relation(fields: [tenantId], references: [id])

  @@map("transaction_document")
}

model BankAccount {
  id                                                               String                                 @id @default(cuid())
  tenantId                                                         String          @map("tenant_id")
  bankName                                                         String          @map("bank_name")
  accountNumber                                                    String          @map("account_number")
  type          BankAccountType // CURRENT, SAVINGS, CREDIT, OTHER

  // NUEVO: referencia a la cuenta contable
  accountId                                                        String?
  account                                                          ChartOfAccount? @relation(fields: [accountId], references: [id])

  createdAt                                                        DateTime        @map("created_at")     @default(now())
  updatedAt                                                        DateTime        @map("updated_at")     @updatedAt

  tenant                                                           Tenant          @relation(fields: [tenantId], references: [id])
  movements                                                        BankMovement[]
  transaction                                                      Transaction[]

  @@map("bank_account")
}

model BankMovement {
  id               String                                        @id @default(cuid())
  tenantId         String               @map("tenant_id")
  tenant           Tenant               @relation(fields: [tenantId], references: [id])
  type             BankMovementType
  date             DateTime             @map("date")
  reference        String?              @map("reference")
  bankAccountId    String               @map("bank_account_id")
  bankAccount      BankAccount          @relation(fields: [bankAccountId], references: [id])
  amount           Float
  description      String?

  journalEntryId   String?              @map("journal_entry_id") @unique
  journalEntry     JournalEntry?        @relation(fields: [journalEntryId], references: [id])

  transactionId    String?              @map("transaction_id")
  transaction      Transaction?         @relation(fields: [transactionId], references: [id])

  createdAt        DateTime             @map("created_at")       @default(now())

  details          BankMovementDetail[]
  bankTransfersOut BankTransfer[]       @relation("TransferOut")
  bankTransfersIn  BankTransfer[]       @relation("TransferIn")

  @@map("bank_movement")
}

model BankMovementDetail {
  id             String                                  @id @default(cuid())
  tenantId       String         @map("tenant_id")
  tenant         Tenant         @relation(fields: [tenantId], references: [id])

  bankMovementId String         @map("bank_movement_id")
  bankMovement   BankMovement   @relation(fields: [bankMovementId], references: [id])

  accountId      String         @map("account_id")
  account        ChartOfAccount @relation(fields: [accountId], references: [id])

  costCenterId   String?        @map("cost_center_id")
  costCenter     CostCenter?    @relation(fields: [costCenterId], references: [id])

  description    String?
  amount         Float

  createdAt      DateTime       @map("created_at")       @default(now())

  @@map("bank_movement_detail")
}

model BankTransfer {
  id            String                                @id @default(uuid())
  tenantId      String        @map("tenant_id")

  fromAccountId String        @map("from_account_id")
  toAccountId   String        @map("to_account_id")

  amount        Decimal
  date          DateTime                              @default(now())
  description   String?
  reference     String?

  movementOutId String?                               @unique
  movementInId  String?                               @unique

  movementOut   BankMovement? @relation("TransferOut", fields: [movementOutId], references: [id], onDelete: Cascade)
  movementIn    BankMovement? @relation("TransferIn", fields: [movementInId], references: [id], onDelete: Cascade)

  createdAt     DateTime      @map("created_at")      @default(now())

  tenant        Tenant        @relation(fields: [tenantId], references: [id])

  @@map("bank_transfer")
}

model CashBox {
  id            String                             @id @default(cuid())
  name          String

  accountId     String?
  account       ChartOfAccount? @relation(fields: [accountId], references: [id])

  tenantId      String          @map("tenant_id")
  tenant        Tenant          @relation(fields: [tenantId], references: [id])

  isActive      Boolean                            @default(true)
  createdAt     DateTime        @map("created_at") @default(now())
  updatedAt     DateTime        @map("updated_at") @updatedAt

  cashMovements CashMovement[]
  cashSession   CashSession[]
  transaction   Transaction[]

  @@map("cash_box")
}

model CashSession {
  id                 String                                   @id @default(cuid())
  tenantId           String               @map("tenant_id")
  cashBoxId          String               @map("cash_box_id")
  userId             String               @map("user_id")

  openedAt           DateTime             @map("opened_at")   @default(now())
  closedAt           DateTime?            @map("closed_at")
  initialAmount      Float
  closingAmount      Float?
  status             CashSessionStatus                        @default(OPEN)
  notes              String?              @map("notes")

  cashBox            CashBox              @relation(fields: [cashBoxId], references: [id])
  tenant             Tenant               @relation(fields: [tenantId], references: [id])
  user               User                 @relation(fields: [userId], references: [id])

  totalIn            Float?
  totalOut           Float?
  difference         Float?

  cashMovements      CashMovement[]
  cashCount          CashCount[]
  cashReconciliation CashReconciliation[]

  @@index([cashBoxId, status])
  @@map("cash_session")
}

model CashMovement {
  id             String                                        @id @default(cuid())

  cashSessionId  String?              @map("cash_session_id")
  cashSession    CashSession?         @relation(fields: [cashSessionId], references: [id])

  cashBoxId      String               @map("cash_box_id")
  cashBox        CashBox              @relation(fields: [cashBoxId], references: [id])

  transactionId  String?              @map("transaction_id")
  transaction    Transaction?         @relation(fields: [transactionId], references: [id])

  // Enlace al diario
  journalEntryId String?              @map("journal_entry_id")
  journalEntry   JournalEntry?        @relation(fields: [journalEntryId], references: [id])

  type           CashMovementType
  category       CashMovementCategory                          @default(OTHER)

  amount         Float
  description    String?
  reference      String?
  issueDate      DateTime             @map("issue_date")       @default(now())

  createdAt      DateTime             @map("created_at")       @default(now())

  accountId      String?
  account        ChartOfAccount?      @relation(fields: [accountId], references: [id])

  tenantId       String               @map("tenant_id")
  tenant         Tenant               @relation(fields: [tenantId], references: [id])

  @@map("cash_movement")
}

model CashCount {
  id            String                              @id @default(cuid())
  cashSessionId String      @map("cash_session_id")
  denomination  Float
  quantity      Int
  total         Float

  cashSession   CashSession @relation(fields: [cashSessionId], references: [id])

  tenantId      String      @map("tenant_id")
  tenant        Tenant      @relation(fields: [tenantId], references: [id])

  @@map("cash_count")
}

model CashReconciliation {
  id             String                              @id @default(cuid())
  tenantId       String      @map("tenant_id")
  cashSessionId  String      @map("cash_session_id")
  expectedAmount Float       @map("expected_amount")
  actualAmount   Float       @map("actual_amount")
  difference     Float

  cashSession    CashSession @relation(fields: [cashSessionId], references: [id])
  tenant         Tenant      @relation(fields: [tenantId], references: [id])

  @@map("cash_reconciliation")
}

model Person {
  id                  String                                               @id @default(cuid())
  personKind          PersonKind                                           @default(NATURAL)

  // Identificaci√≥n primaria
  identificationType  IdentificationType     @map("identification_type")
  identification      String                 @map("identification")        @unique
  // Identificaciones secundarias
  identifications     PersonIdentification[]

  firstName           String?                @map("first_name")
  lastName            String?                @map("last_name")
  businessName        String?                @map("business_name")
  commercialName      String?                @map("commercial_name")
  email               String                 @map("email")
  phone               String?                @map("phone")
  address             String?                @map("address")

  accountReceivableId String?                @map("account_receivable_id")
  accountPayableId    String?                @map("account_payable_id")

  isCustomer          Boolean                                              @default(false)
  accountReceivable   ChartOfAccount?        @relation("person_account_receivable", fields: [accountReceivableId], references: [id])

  isSupplier          Boolean                                              @default(false)
  accountPayable      ChartOfAccount?        @relation("person_account_payable", fields: [accountPayableId], references: [id])

  isActive            Boolean                                              @default(true)

  createdAt           DateTime               @map("created_at")            @default(now())
  updatedAt           DateTime               @map("updated_at")            @updatedAt

  tenantId            String                 @map("tenant_id")
  tenant              Tenant                 @relation(fields: [tenantId], references: [id])

  transactions        Transaction[]
  documents           Document[]
  ledgerEntries       JournalEntryLine[]

  @@map("person")
}

model PersonIdentification {
  id                 String                                @id @default(cuid())
  personId           String             @map("person_id")
  person             Person             @relation(fields: [personId], references: [id])

  identificationType IdentificationType
  identification     String

  isPrimary          Boolean            @map("is_primary") @default(false)

  @@unique([identificationType, identification])
  @@map("person_identification")
}

// ------------------------------
// CAT√ÅLOGO DE CUENTAS
// ------------------------------
model ChartOfAccountTemplate {
  id          String       @id @default(uuid())
  code        String
  name        String
  accountType AccountType
  parentCode  String?

  @@map("chart_of_account_template")
}

model ChartOfAccount {
  id                         String                                 @id @default(uuid())
  tenantId                   String               @map("tenant_id")
  code                       String
  name                       String
  accountType                AccountType
  parentId                   String?              @map("parent_id")
  parent                     ChartOfAccount?      @relation("AccountHierarchy", fields: [parentId], references: [id])
  children                   ChartOfAccount[]     @relation("AccountHierarchy")
  isActive                   Boolean                                @default(true)

  ledgerEntries              JournalEntryLine[]

  // NUEVOS ‚Üí relaciones inversas necesarias
  accountInventoryWarehouses Warehouse[]          @relation("WarehouseInventoryAccount")
  personsReceivable          Person[]             @relation("person_account_receivable")
  personsPayable             Person[]             @relation("person_account_payable")
  productsSales              Product[]            @relation("ProductSalesAccount")
  productsInventory          Product[]            @relation("ProductInventoryAccount")
  productsCost               Product[]            @relation("ProductCostAccount")

  bankAccounts               BankAccount[]
  cashBox                    CashBox[]
  cashMovement               CashMovement[]
  bankTransaction            BankTransaction[]
  bankMovementDetail         BankMovementDetail[]

  @@map("chart_of_account")
}

// ------------------------------
// COMPROBANTES CONTABLES
// ------------------------------
model JournalEntry {
  id            String                                 @id @default(uuid())
  tenantId      String             @map("tenant_id")
  date          DateTime
  description   String?
  type          EntryType                              @default(ENTRY)

  // üîπ Nuevo: qu√© tipo de evento lo gener√≥
  sourceType    JournalSourceType  @map("source_type")
  // üîπ Id de la entidad origen (documento, movimiento, etc.)
  sourceId      String?            @map("source_id")

  // Relaci√≥n con l√≠neas
  lines         JournalEntryLine[]
  bankMovement  BankMovement?
  cashMovements CashMovement[]

  createdAt     DateTime           @map("created_at")  @default(now())
  updatedAt     DateTime           @map("updated_at")  @updatedAt

  @@map("journal_entry")
}

// ------------------------------
// L√çNEAS DEL ASIENTO CONTABLE
// ------------------------------
model JournalEntryLine {
  id             String                                  @id @default(uuid())
  tenantId       String         @map("tenant_id")
  journalEntryId String         @map("journal_entry_id")
  journalEntry   JournalEntry   @relation(fields: [journalEntryId], references: [id])

  accountId      String         @map("account_id")
  account        ChartOfAccount @relation(fields: [accountId], references: [id])

  debit          Decimal                                 @default(0.00)
  credit         Decimal                                 @default(0.00)

  personId       String?        @map("person_id")
  person         Person?        @relation(fields: [personId], references: [id])

  costCenterId   String?        @map("cost_center_id")
  createdAt      DateTime       @map("created_at")       @default(now())
  costCenter     CostCenter?    @relation(fields: [costCenterId], references: [id])

  @@map("journal_entry_line")
}

// ------------------------------
// CENTROS DE COSTO
// ------------------------------
model CostCenter {
  id                  String                                 @id @default(uuid())
  tenantId            String               @map("tenant_id")
  code                String
  name                String
  isActive            Boolean                                @default(true)

  ledgerEntries       JournalEntryLine[]
  warehouses          Warehouse[]
  bankMovementDetails BankMovementDetail[]

  @@unique([tenantId, code])
  @@map("cost_center")
}

// ------------------------------
// IMPUESTOS (IVA, retenciones, etc.)
// ------------------------------
model Tax {
  id       String                    @id @default(uuid())
  tenantId String  @map("tenant_id")
  name     String
  rate     Decimal

  @@map("tax")
}

// ------------------------------
// MOVIMIENTOS DE CUENTAS BANCARIAS (para conciliaci√≥n)
// ------------------------------
model BankTransaction {
  id          String                            @id @default(uuid())
  tenantId    String         @map("tenant_id")
  date        DateTime
  description String?
  amount      Decimal
  reference   String?
  accountId   String         @map("account_id")
  account     ChartOfAccount @relation(fields: [accountId], references: [id])
  matched     Boolean                           @default(false)

  @@map("bank_transaction")
}

enum Status {
  ACTIVE
  INACTIVE
}

enum UserRole {
  ADMIN
  USER
}

enum IdentificationType {
  RUC
  CEDULA
  PASAPORTE
  VENTA_A_CONSUMIDOR_FINAL
  IDENTIFICACION_DE_EXTERIOR
  PLACA
}

enum TaxType {
  IVA_0
  IVA_5
  IVA_12
  IVA_14
  IVA_15
  NO_IVA
  EXENTO_IVA
}

enum TransactionType {
  INCOME // Cobro
  EXPENSE // Pago
}

enum PaymentMethod {
  CASH // Caja
  TRANSFER // Transferencia
  PETTY_CASH // Caja chica (solo para pagos)
  CREDIT_CARD // Tarjeta cr√©dito (solo para pagos)
}

enum DocumentStatus {
  DRAFT
  CONFIRMED
  CANCELED
}

enum EntityType {
  CUSTOMER
  SUPPLIER
}

enum SRIStatus {
  DRAFT        // A√∫n no firmado / no enviado
  SENT         // Enviado a recepci√≥n SRI
  RECEIVED     // SRI lo recibi√≥ (RECIBIDA)
  IN_PROCESS   // Esperando autorizaci√≥n
  AUTHORIZED   // Autorizada
  REJECTED     // Rechazada
}

enum SRIEnvironment {
  TEST
  PRODUCTION
}

enum AccountKind {
  BANK
  CASH
  CARD
  WALLET
}

enum BankMovementType {
  DEBIT
  CREDIT
}

enum CashMovementType {
  IN
  OUT
}

enum TransferStatus {
  PENDING
  APPROVED
  CANCELED
}

enum InventoryMoveType {
  IN
  OUT
  TRANSFER
  ADJUST
}

enum ProductType {
  PRODUCT
  SERVICE
}

// ------------------------------
// ENUMS
// ------------------------------
enum AccountType {
  ASSET // Activos
  LIABILITY // Pasivos
  EQUITY // Patrimonio
  INCOME // Ingresos
  EXPENSE // Gastos
}

enum DocumentType {
  INVOICE          // Factura
  PURCHASE         // Liquidaci√≥n de compra
  CREDIT_NOTE      // Nota de cr√©dito
  DEBIT_NOTE       // Nota de d√©bito
  WITHHOLDING      // Comprobante de retenci√≥n
  REMISSION_GUIDE  // Gu√≠a de remisi√≥n
}


enum EntryType {
  PURCHASE           // Compra
  SALE               // Venta
  DEPOSIT            // Dep√≥sito
  INVENTORY          // Inventario
  WITHHOLDING        // Retenci√≥n
  ENTRY              // Asiento
  INCOME             // Ingreso
  EXPENSE            // Gasto
  AUTOMATIC_CLOSING  // Cierre autom√°tico
  PAYROLL            // N√≥mina
}

enum JournalSourceType {
  DOCUMENT
  INVENTORY_MOVEMENT
  BANK_MOVEMENT
  CASH_MOVEMENT
  MANUAL_ENTRY
}

enum BankAccountType {
  CURRENT
  SAVINGS
  CREDIT
  OTHER
}

enum RetentionType {
  IVA
  RENTA
}

enum PersonKind {
  NATURAL
  LEGAL
}

enum CashSessionStatus {
  OPEN
  CLOSED
  PENDING
}

enum CashMovementCategory {
  SALE
  PURCHASE
  PETTY_CASH
  ADVANCE
  REFUND
  TRANSFER
  OTHER
}

enum MovementLineType {
  DEBIT
  CREDIT
}

enum ContributorType {
  NATURAL
  SOCIETY
  SPECIAL
  PUBLIC
}

enum TaxRegime {
  GENERAL
  RIMPE_EMPRENDEDOR
  RIMPE_NEGOCIO_POPULAR
}